(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{1196:function(t,e,a){},1450:function(t,e,a){"use strict";a(1196)},602:function(t,e,a){"use strict";a.r(e);a(38),a(49),a(50);var i=a(16),n=a.n(i),s=a(5),r=a.n(s),o=a(0),c=a.n(o),u=a(4),l=a.n(u),d=(a(127),a(27),a(81),a(67),a(183),a(37),a(68),a(103),a(82),a(22),a(26),a(80),a(23),a(43),a(1)),p=a(7),h=a(102),m=a(675),b=a(611),g=a(695),f=a(28),v=a(687),k=a.n(v),_=a(685);function y(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function x(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?y(Object(a),!0).forEach((function(e){r()(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):y(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var w=[{type:"select",label:d.a.t("所属项目"),key:"selectedProject",loading:!0,placeholder:d.a.t("请选择所属项目"),list:[],value:""},{type:"dateRange",key:"executeTime",placeholder:d.a.t("选择日期时间范围"),label:d.a.t("执行开始"),value:["",""]},{type:"input",key:"creator",label:d.a.t("创建人"),placeholder:d.a.t("请输入创建人"),value:""},{type:"input",key:"executor",label:d.a.t("执行人"),placeholder:d.a.t("请输入执行人"),value:""},{type:"select",label:d.a.t("状态"),key:"statusSync",loading:!1,placeholder:d.a.t("请选择状态"),list:[{value:"nonExecution",name:d.a.t("未执行")},{value:"running",name:d.a.t("未完成")},{value:"revoked",name:d.a.t("撤销")},{value:"finished",name:d.a.t("完成")}],value:""},{type:"select",label:d.a.t("任务分类"),key:"category",loading:!0,placeholder:d.a.t("请选择分类"),tips:d.a.t("模板分类即将下线，建议使用标签"),list:[],value:""}],j=[{id:"id",label:d.a.t("ID"),width:80},{id:"project",label:d.a.t("所属项目"),disabled:!0,width:120},{id:"name",label:d.a.t("任务名称"),disabled:!0,min_width:200},{id:"start_time",label:d.a.t("执行开始"),width:200},{id:"finish_time",label:d.a.t("执行结束"),width:200},{id:"category_name",label:d.a.t("任务类型"),width:140},{id:"creator_name",label:d.a.t("创建人"),width:140},{id:"executor_name",label:d.a.t("执行人"),width:140},{id:"audit_status",label:d.a.t("状态"),width:120}],O={name:"auditHome",components:{Skeleton:m.a,AdvanceSearchForm:g.a,NoData:b.a},mixins:[h.a,_.a],data:function(){var t=this,e=this.$route.query,a=e.page,i=void 0===a?1:a,n=e.limit,s=void 0===n?15:n,r=e.selectedProject,o=void 0===r?"":r,u=e.category,l=void 0===u?"":u,d=e.executeTime,p=void 0===d?"":d,h=e.creator,m=void 0===h?"":h,b=e.executor,g=void 0===b?"":b,f=e.statusSync,v=void 0===f?"":f,k=e.keyword,_=void 0===k?"":k;return{firstLoading:!0,taskBasicInfoLoading:!0,listLoading:!1,activeTaskCategory:void 0,business:{list:[],loading:!1,id:null,searchable:!0,empty:!1},searchForm:w.map(function(e){return c()(this,t),this.$route.query[e.key]&&(Array.isArray(e.value)?e.value=this.$route.query[e.key].split(","):e.value="selectedProject"===e.key?Number(this.$route.query[e.key]):this.$route.query[e.key]),e}.bind(this)),isSearchFormOpen:w.some(function(e){return c()(this,t),this.$route.query[e.key]}.bind(this)),auditList:[],taskCategory:[],executeStatus:[],requestData:{selectedProject:o,category:l,creator:m,executor:g,statusSync:v,executeTime:p?p.split(","):["",""],taskName:_},pagination:{current:Number(i),count:0,limit:Number(s),"limit-list":[15,30,50,100]},tableFields:j,setting:{fieldList:j,selectedFields:j.slice(0),size:"small"}}},computed:x({},Object(p.e)("project",{timeZone:function(t){return c()(this,void 0),t.timezone}.bind(void 0)})),created:function(){var t=this;return n()(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.getFields(),t.loadAuditTask(),t.getProjectBaseInfo(),t.onSearchInput=f.a.debounce(t.searchInputhandler,500),e.next=6,t.getProjectList();case 6:t.firstLoading=!1;case 7:case"end":return e.stop()}}),e)})))()},methods:x(x(x(x(x({},Object(p.b)("auditTask/",["loadAuditTaskList"])),Object(p.b)("task/",["getInstanceStatus"])),Object(p.b)("template/",["loadProjectBaseInfo"])),Object(p.b)("project/",["loadUserProjectList"])),{},{loadAuditTask:function(){var t=this;return n()(l.a.mark((function e(){var a,i,n,s,r,o,c,u,d,p,h,m,b,g;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.listLoading=!0,e.prev=1,a=t.requestData,i=a.selectedProject,n=a.executeTime,s=a.category,r=a.creator,o=a.executor,c=a.statusSync,u=a.taskName,e.t0=c,e.next="nonExecution"===e.t0?6:"running"===e.t0?8:"revoked"===e.t0?12:"finished"===e.t0?14:16;break;case 6:return d=!1,e.abrupt("break",16);case 8:return d=!0,p=!1,h=!1,e.abrupt("break",16);case 12:return h=!0,e.abrupt("break",16);case 14:return p=!0,e.abrupt("break",16);case 16:return m={limit:t.pagination.limit,offset:(t.pagination.current-1)*t.pagination.limit,project__id:i||void 0,category:s||void 0,pipeline_instance__name__contains:u||void 0,pipeline_instance__is_started:d,pipeline_instance__is_finished:p,pipeline_instance__is_revoked:h,pipeline_instance__creator__contains:r||void 0,pipeline_instance__executor__contains:o||void 0},n[0]&&n[1]&&(t.common?(m.pipeline_template__start_time__gte=k()(n[0]).format("YYYY-MM-DD"),m.pipeline_template__start_time__lte=k()(n[1]).add("1","d").format("YYYY-MM-DD")):(m.pipeline_instance__start_time__gte=k.a.tz(n[0],t.timeZone).format("YYYY-MM-DD"),m.pipeline_instance__start_time__lte=k.a.tz(n[1],t.timeZone).add("1","d").format("YYYY-MM-DD"))),e.next=20,t.loadAuditTaskList(m);case 20:b=e.sent,g=b.objects,t.auditList=g,t.pagination.count=b.meta.total_count,t.totalCount=b.meta.total_count,t.getExecuteStatus("executeStatus",g),e.next=31;break;case 28:e.prev=28,e.t1=e.catch(1),console.log(e.t1);case 31:return e.prev=31,t.listLoading=!1,e.finish(31);case 34:case"end":return e.stop()}}),e,null,[[1,28,31,34]])})))()},getFields:function(){var t=this,e=localStorage.getItem("AuditList");if(e){var a=JSON.parse(e),i=a.fieldList,n=a.size;this.setting.size=n,this.setting.selectedFields=this.tableFields.slice(0).filter(function(e){return c()(this,t),i.includes(e.id)}.bind(this))}},handleSettingChange:function(t){var e=this,a=t.fields,i=t.size;this.setting.size=i,this.setting.selectedFields=a;var n=a.map(function(t){return c()(this,e),t.id}.bind(this));localStorage.setItem("AuditList",JSON.stringify({fieldList:n,size:i}))},onPageChange:function(t){this.pagination.current=t,this.updateUrl(),this.loadAuditTask()},onPageLimitChange:function(t){this.pagination.limit=t,this.pagination.current=1,this.updateUrl(),this.loadAuditTask()},updateUrl:function(){var t=this,e=this.pagination,a=e.current,i=e.limit,n=this.requestData,s=n.selectedProject,r=n.category,o=n.executeTime,u=n.creator,l=n.executor,d=n.statusSync,p=n.taskName,h={limit:i,selectedProject:s,category:r,creator:u,executor:l,statusSync:d,page:a,executeTime:o.every(function(e){return c()(this,t),e}.bind(this))?o.join(","):"",keyword:p},m={};Object.keys(h).forEach(function(e){c()(this,t);var a=h[e];(a||0===a||!1===a)&&(m[e]=a)}.bind(this)),this.$router.push({name:"auditHome",query:m})},searchInputhandler:function(t){this.requestData.taskName=t,this.pagination.current=1,this.loadAuditTask()},getProjectList:function(){var t=this;return n()(l.a.mark((function e(){var a,i,n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.business.loading=!0,e.prev=1,e.next=4,t.loadUserProjectList({limit:0});case 4:a=e.sent,t.business.list=a.objects,(i=t.searchForm.find(function(t){return c()(this,n),"selectedProject"===t.key}.bind(this))).list=t.business.list.map(function(t){return c()(this,n),{name:t.name,value:t.id}}.bind(this)),i.loading=!1,e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:return e.prev=14,t.business.loading=!1,e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])})))()},getProjectBaseInfo:function(){var t=this;return n()(l.a.mark((function e(){var a,i,n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.taskBasicInfoLoading=!0,e.prev=1,e.next=4,t.loadProjectBaseInfo();case 4:a=e.sent,t.taskCategory=a.data.task_categories.map(function(t){return c()(this,n),{name:t.name,value:t.value}}.bind(this)),(i=t.searchForm.find(function(t){return c()(this,n),"category"===t.key}.bind(this))).list=t.taskCategory,i.loading=!1,e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:return e.prev=14,t.taskBasicInfoLoading=!1,e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])})))()},onClearCategory:function(){this.activeTaskCategory=void 0},onSelectedCategory:function(t){this.activeTaskCategory=t},onTemplatePermissonCheck:function(t){if(!this.hasPermission(["task_view"],t.auth_actions)){var e={task:[{id:t.id,name:t.name}],project:[{id:t.project.id,name:t.project.name}]};this.applyForPermission(["task_view"],t.auth_actions,e)}},onSearchFormSubmit:function(t){this.requestData=Object.assign({},this.requestData,t),this.pagination.current=1,this.updateUrl(),this.loadAuditTask()}})},P=(a(1450),a(9)),S=Object(P.a)(O,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"audit-container"},[a("skeleton",{attrs:{loading:t.firstLoading,loader:"commonList"}},[a("div",{staticClass:"list-wrapper"},[a("advance-search-form",{attrs:{id:"auditList",open:t.isSearchFormOpen,"search-config":{placeholder:t.$t("请输入任务名称")},"search-form":t.searchForm},on:{onSearchInput:t.onSearchInput,submit:t.onSearchFormSubmit}}),t._v(" "),a("div",{staticClass:"audit-table-content"},[a("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:!t.firstLoading&&t.listLoading,opacity:1,zIndex:100},expression:"{ isLoading: !firstLoading && listLoading, opacity: 1, zIndex: 100 }"}],attrs:{data:t.auditList,pagination:t.pagination,size:t.setting.size},on:{"page-change":t.onPageChange,"page-limit-change":t.onPageLimitChange}},[t._l(t.setting.selectedFields,(function(e){return a("bk-table-column",{key:e.id,attrs:{label:e.label,prop:e.id,width:e.width,"min-width":e.min_width},scopedSlots:t._u([{key:"default",fn:function(i){return["project"===e.id?a("div",[a("span",{attrs:{title:i.row.project.name}},[t._v(t._s(i.row.project.name))])]):"name"===e.id?a("div",[t.hasPermission(["task_view"],i.row.auth_actions)?a("router-link",{staticClass:"task-name",attrs:{title:i.row.name,to:{name:"auditTaskExecute",params:{project_id:i.row.project.id},query:{instance_id:i.row.id}}}},[t._v("\n                                    "+t._s(i.row.name)+"\n                                ")]):a("a",{directives:[{name:"cursor",rawName:"v-cursor"}],staticClass:"text-permission-disable",attrs:{title:i.row.name},on:{click:function(e){return t.onTemplatePermissonCheck(i.row)}}},[t._v("\n                                    "+t._s(i.row.name)+"\n                                ")])],1):"audit_status"===e.id?a("div",{staticClass:"audit-status"},[a("span",{class:t.executeStatus[i.$index]&&t.executeStatus[i.$index].cls}),t._v(" "),t.executeStatus[i.$index]?a("span",{staticClass:"task-status-text"},[t._v(t._s(t.executeStatus[i.$index].text))]):t._e()]):[a("span",{attrs:{title:i.row[e.id]||"--"}},[t._v(t._s(i.row[e.id]||"--"))])]]}}],null,!0)})})),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("操作"),width:"100"},scopedSlots:t._u([{key:"default",fn:function(e){return[t.hasPermission(["task_view"],e.row.auth_actions)?a("router-link",{staticClass:"audit-operation-btn",attrs:{to:{name:"auditTaskExecute",params:{project_id:e.row.project.id},query:{instance_id:e.row.id}}}},[t._v("\n                                "+t._s(t.$t("查看"))+"\n                            ")]):a("a",{directives:[{name:"cursor",rawName:"v-cursor"}],staticClass:"text-permission-disable",on:{click:function(a){return t.onTemplatePermissonCheck(e.row)}}},[t._v("\n                                "+t._s(t.$t("查看"))+"\n                            ")])]}}])}),t._v(" "),a("bk-table-column",{attrs:{type:"setting"}},[a("bk-table-setting-content",{attrs:{fields:t.setting.fieldList,selected:t.setting.selectedFields,size:t.setting.size},on:{"setting-change":t.handleSettingChange}})],1),t._v(" "),a("div",{staticClass:"empty-data",attrs:{slot:"empty"},slot:"empty"},[a("NoData")],1)],2)],1)],1)])],1)}),[],!1,null,"5048c39d",null);e.default=S.exports},685:function(t,e,a){"use strict";a(26),a(38),a(37),a(49),a(22),a(50);var i=a(16),n=a.n(i),s=a(0),r=a.n(s),o=a(5),c=a.n(o),u=a(4),l=a.n(u),d=(a(127),a(184),a(7)),p=a(1);function h(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function m(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?h(Object(a),!0).forEach((function(e){c()(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):h(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var b={methods:m(m({},Object(d.b)("task/",["getInstanceStatus"])),{},{getExecuteStatus:function(t,e){var a=this;this[t]=e.map(function(e,i){r()(this,a);var n={};return e.is_expired?(n.cls="expired bk-icon icon-clock-shape",n.text=p.a.t("已过期")):e.is_finished?(n.cls="finished bk-icon icon-check-circle-shape",n.text=p.a.t("完成")):e.is_revoked?(n.cls="revoke common-icon-dark-circle-shape",n.text=p.a.t("撤销")):e.is_started?(n.cls="loading common-icon-loading",this.getExecuteDetail(t,e,i)):(n.cls="created common-icon-dark-circle-shape",n.text=p.a.t("未执行")),n}.bind(this))},getExecuteDetail:function(t,e,a){var i=this;return n()(l.a.mark((function n(){var s,r,o,c;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s={instance_id:e.id,project_id:e.project.id},n.prev=1,n.next=4,i.getInstanceStatus(s);case 4:if(!(r=n.sent).result){n.next=28;break}o=r.data.state,c={},n.t0=o,n.next="RUNNING"===n.t0||"BLOCKED"===n.t0?11:"READY"===n.t0?14:"SUSPENDED"===n.t0?17:"NODE_SUSPENDED"===n.t0?20:"FAILED"===n.t0?23:26;break;case 11:return c.cls="running common-icon-dark-circle-ellipsis",c.text=p.a.t("执行中"),n.abrupt("break",27);case 14:return c.cls="running common-icon-dark-circle-ellipsis",c.text=p.a.t("排队中"),n.abrupt("break",27);case 17:return c.cls="execute common-icon-dark-circle-pause",c.text=p.a.t("暂停"),n.abrupt("break",27);case 20:return c.cls="execute",c.text=p.a.t("节点暂停"),n.abrupt("break",27);case 23:return c.cls="failed common-icon-dark-circle-close",c.text=p.a.t("失败"),n.abrupt("break",27);case 26:c.text=p.a.t("未知");case 27:i[t].splice(a,1,c);case 28:n.next=33;break;case 30:n.prev=30,n.t1=n.catch(1),console.log(n.t1);case 33:case"end":return n.stop()}}),n,null,[[1,30]])})))()}})};e.a=b}}]);