(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{1148:function(e,t,a){},1149:function(e,t,a){},1400:function(e,t,a){"use strict";a(1148)},1401:function(e,t,a){"use strict";a(1149)},576:function(e,t,a){"use strict";a.r(t);a(38),a(49),a(50);var s=a(51),i=a.n(s),n=a(16),r=a.n(n),o=a(5),c=a.n(o),l=a(0),u=a.n(l),d=a(4),p=a.n(d),h=(a(67),a(127),a(27),a(81),a(183),a(80),a(37),a(68),a(103),a(24),a(23),a(82),a(22),a(26),a(101),a(39),a(104),a(128),a(185),a(43),a(1)),m=a(7),k=a(28),f=a(695),v=a(858),_=a(611),b=a(687),g=a.n(b),T=(a(314),a(6)),y={name:"TaskCloneDialog",props:["isTaskCloneDialogShow","taskName","pending"],data:function(){return{name:"copy"+this.taskName.slice(0,T.i.TASK_NAME_MAX_LENGTH-4),taskNameRule:{required:!0,max:T.i.TASK_NAME_MAX_LENGTH,regex:T.e}}},watch:{taskName:function(e){this.name="copy"+e.slice(0,T.i.TASK_NAME_MAX_LENGTH-4)}},methods:{onConfirm:function(){var e=this;this.$validator.validateAll().then(function(t){u()(this,e),t&&(this.name=this.name.trim(),this.$emit("confirm",this.name))}.bind(this))},onCancel:function(){this.$emit("cancel")}}},C=(a(1400),a(9)),w=Object(C.a)(y,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("bk-dialog",{attrs:{width:"600","ext-cls":"common-dialog",theme:"primary","mask-close":!1,"header-position":"left",title:e.$t("任务克隆"),value:e.isTaskCloneDialogShow},on:{confirm:e.onConfirm,cancel:e.onCancel}},[a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.pending,opacity:1,zIndex:100},expression:"{ isLoading: pending, opacity: 1, zIndex: 100 }"}],staticClass:"clone-wrapper"},[a("div",{staticClass:"common-form-item"},[a("label",[e._v(e._s(e.$t("任务名称")))]),e._v(" "),a("div",{staticClass:"common-form-content"},[a("bk-input",{directives:[{name:"validate",rawName:"v-validate",value:e.taskNameRule,expression:"taskNameRule"}],attrs:{name:"taskName"},model:{value:e.name,callback:function(t){e.name=t},expression:"name"}}),e._v(" "),e.veeErrors.has("taskName")?a("span",{staticClass:"common-error-tip error-msg"},[e._v(e._s(e.veeErrors.first("taskName")))]):e._e()],1)])])])}),[],!1,null,"2a3ecce6",null).exports,x=a(675),L=a(102),j=a(685);function P(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function D(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?P(Object(a),!0).forEach((function(t){c()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):P(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var S=[{type:"dateRange",key:"executeTime",placeholder:h.a.t("选择日期时间范围"),label:h.a.t("执行开始"),value:["",""]},{type:"select",label:h.a.t("创建方式"),key:"createMethod",loading:!0,placeholder:h.a.t("请选择创建方式"),list:[],value:""},{type:"input",key:"creator",label:h.a.t("创建人"),placeholder:h.a.t("请输入创建人"),value:""},{type:"input",key:"executor",label:h.a.t("执行人"),placeholder:h.a.t("请输入执行人"),value:""},{type:"select",label:h.a.t("状态"),key:"statusSync",loading:!1,placeholder:h.a.t("请选择状态"),list:[{value:"nonExecution",name:h.a.t("未执行")},{value:"running",name:h.a.t("未完成")},{value:"revoked",name:h.a.t("撤销")},{value:"finished",name:h.a.t("完成")}],value:""},{type:"select",label:h.a.t("任务分类"),key:"category",loading:!0,placeholder:h.a.t("请选择分类"),list:[],value:""}],O=[{id:"id",label:h.a.t("ID"),width:100},{id:"name",label:h.a.t("任务名称"),disabled:!0,min_width:240},{id:"start_time",label:h.a.t("执行开始"),width:200},{id:"finish_time",label:h.a.t("执行结束"),width:200},{id:"create_time",label:h.a.t("创建时间"),width:200},{id:"category_name",label:h.a.t("任务类型"),width:100},{id:"creator_name",label:h.a.t("创建人"),width:120},{id:"executor_name",label:h.a.t("执行人"),width:120},{id:"create_method",label:h.a.t("创建方式"),width:100},{id:"task_status",label:h.a.t("状态"),width:120}],N={name:"TaskList",components:{Skeleton:x.a,NoData:_.a,TaskCreateDialog:v.a,TaskCloneDialog:w,AdvanceSearchForm:f.a},mixins:[L.a,j.a],props:{project_id:{type:[String,Number],default:""}},data:function(){var e=this,t=this.$route.query,a=t.page,s=void 0===a?1:a,i=t.limit,n=void 0===i?15:i,r=t.template_source,o=void 0===r?"":r,c=t.create_info,l=void 0===c?"":c,d=t.category,p=void 0===d?"":d,h=t.executeTime,m=void 0===h?"":h,k=t.create_method,f=void 0===k?"":k,v=t.creator,_=void 0===v?"":v,b=t.executor,g=void 0===b?"":b,T=t.statusSync,y=void 0===T?"":T,C=t.keyword,w=void 0===C?"":C,x=S.map(function(t){return u()(this,e),this.$route.query[t.key]&&(Array.isArray(t.value)?t.value=this.$route.query[t.key].split(","):t.value=this.$route.query[t.key]),t}.bind(this)),L=S.some(function(t){return u()(this,e),this.$route.query[t.key]}.bind(this));return{firstLoading:!0,listLoading:!1,templateId:this.$route.query.template_id,taskCategory:[],searchStr:"",searchForm:x,isSearchFormOpen:L,executeStatus:[],totalPage:1,isDeleteDialogShow:!1,shapeShow:!1,theDeleteTaskId:void 0,theDeleteTaskName:"",isTaskCloneDialogShow:!1,isNewTaskDialogShow:!1,businessInfoLoading:!0,theCloneTaskName:"",theCloneTaskId:void 0,pending:{delete:!1,clone:!1},taskBasicInfoLoading:!0,taskCreateMethodList:[],createMethod:f,createInfo:l,templateSource:o,requestData:{executeTime:m?m.split(","):["",""],category:p,creator:_,executor:g,statusSync:y,createMethod:f,taskName:w},pagination:{current:Number(s),count:0,limit:Number(n),"limit-list":[15,30,50,100]},tableFields:O,defaultSelected:["id","name","start_time","finish_time","executor_name","task_status"],setting:{fieldList:O,selectedFields:O.slice(0),size:"small"}}},computed:D(D({},Object(m.e)({taskList:function(e){return u()(this,void 0),e.taskList.taskListData}.bind(void 0)})),Object(m.e)("project",{authActions:function(e){return u()(this,void 0),e.authActions}.bind(void 0),timeZone:function(e){return u()(this,void 0),e.timezone}.bind(void 0)})),created:function(){var e=this;return r()(p.a.mark((function t(){return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.getFields(),e.onSearchInput=k.a.debounce(e.searchInputhandler,500),t.next=4,e.getData();case 4:e.firstLoading=!1;case 5:case"end":return t.stop()}}),t)})))()},methods:D(D(D(D(D(D({},Object(m.b)("template/",["loadProjectBaseInfo"])),Object(m.b)("task/",["getInstanceStatus","loadCreateMethod"])),Object(m.b)("taskList/",["loadTaskList","deleteTask","cloneTask"])),Object(m.d)("template/",["setProjectBaseInfo"])),Object(m.d)("taskList/",["setTaskListData"])),{},{getTaskList:function(){var e=this;return r()(p.a.mark((function t(){var a,s,i,n,r,o,c,l,u,d,h,m,k,f,v;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.listLoading=!0,e.executeStatus=[],t.prev=2,a=e.requestData,s=a.executeTime,i=a.category,n=a.createMethod,r=a.creator,o=a.executor,c=a.statusSync,l=a.taskName,t.t0=c,t.next="nonExecution"===t.t0?7:"running"===t.t0?9:"revoked"===t.t0?13:"finished"===t.t0?15:17;break;case 7:return u=!1,t.abrupt("break",17);case 9:return u=!0,d=!1,h=!1,t.abrupt("break",17);case 13:return h=!0,t.abrupt("break",17);case 15:return d=!0,t.abrupt("break",17);case 17:return m={limit:e.pagination.limit,offset:(e.pagination.current-1)*e.pagination.limit,category:i||void 0,template_id:e.templateId||void 0,pipeline_instance__creator__contains:r||void 0,pipeline_instance__executor__contains:o||void 0,pipeline_instance__name__icontains:l||void 0,pipeline_instance__is_started:u,pipeline_instance__is_finished:d,pipeline_instance__is_revoked:h,create_method:n||void 0,create_info:e.createInfo||void 0,project__id:e.project_id,template_source:e.templateSource||void 0},s[0]&&s[1]&&("common"===e.template_source?(m.pipeline_template__start_time__gte=g()(s[0]).format("YYYY-MM-DD"),m.pipeline_template__start_time__lte=g()(s[1]).add("1","d").format("YYYY-MM-DD")):(m.pipeline_instance__start_time__gte=g.a.tz(s[0],e.timeZone).format("YYYY-MM-DD"),m.pipeline_instance__start_time__lte=g.a.tz(s[1],e.timeZone).add("1","d").format("YYYY-MM-DD"))),t.next=21,e.loadTaskList(m);case 21:k=t.sent,f=k.objects,e.pagination.count=k.meta.total_count,e.totalCount=k.meta.total_count,v=Math.ceil(e.pagination.count/e.pagination.limit),e.totalPage=v||1,e.getExecuteStatus("executeStatus",f),e.setTaskListData(f),t.next=34;break;case 31:t.prev=31,t.t1=t.catch(2),console.log(t.t1);case 34:return t.prev=34,e.listLoading=!1,t.finish(34);case 37:case"end":return t.stop()}}),t,null,[[2,31,34,37]])})))()},getBizBaseInfo:function(){var e=this;return r()(p.a.mark((function t(){var a,s,i=this;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.loadProjectBaseInfo();case 3:a=t.sent,e.taskCategory=a.data.task_categories,e.setProjectBaseInfo(a.data),e.taskBasicInfoLoading=!1,(s=e.searchForm.find(function(e){return u()(this,i),"category"===e.key}.bind(this))).list=e.taskCategory,s.loading=!1,t.next=15;break;case 12:t.prev=12,t.t0=t.catch(0),console.log(t.t0);case 15:case"end":return t.stop()}}),t,this,[[0,12]])})))()},getFields:function(){var e,t=this,a=localStorage.getItem("TaskList");if(a){var s=JSON.parse(a),i=s.fieldList,n=s.size;e=i,this.setting.size=n}else e=this.defaultSelected;this.setting.selectedFields=this.tableFields.slice(0).filter(function(a){return u()(this,t),e.includes(a.id)}.bind(this))},searchInputhandler:function(e){this.requestData.taskName=e,this.pagination.current=1,this.getTaskList()},hasCreateTaskPerm:function(e){var t=[].concat(i()(e.auth_actions),i()(this.authActions)),a="project"===e.template_source?"flow_create_task":"common_flow_create_task";return this.hasPermission([a],t)},getCreateTaskUrl:function(e){var t={name:"taskCreate",query:{template_id:e.template_id},params:{project_id:this.project_id,step:"selectnode"}};return"common"===e.template_source&&(t.query.common=1),t},onTaskPermissonCheck:function(e,t){var a={task:[{id:t.id,name:t.name}],project:[{id:t.project.id,name:t.project.name}]};a["project"===t.template_source?"flow":"common_flow"]=[{id:t.template_id,name:t.template_name}],this.applyForPermission(e,[].concat(i()(t.auth_actions),i()(this.authActions)),a)},onDeleteTask:function(e){this.hasPermission(["task_delete"],e.auth_actions)?(this.theDeleteTaskId=e.id,this.theDeleteTaskName=e.name,this.isDeleteDialogShow=!0):this.onTaskPermissonCheck(["task_delete"],e)},onDeleteConfirm:function(){var e=this;return r()(p.a.mark((function t(){return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.pending.delete){t.next=2;break}return t.abrupt("return");case 2:return e.pending.delete=!0,t.prev=3,t.next=6,e.deleteTask(e.theDeleteTaskId);case 6:return e.theDeleteTaskId=void 0,e.theDeleteTaskName="",e.pagination.current>1&&e.totalPage===e.pagination.current&&e.pagination.count-(e.totalPage-1)*e.pagination.limit==1&&(e.pagination.current-=1),t.next=11,e.getTaskList();case 11:t.next=16;break;case 13:t.prev=13,t.t0=t.catch(3),console.log(t.t0);case 16:return t.prev=16,e.isDeleteDialogShow=!1,e.pending.delete=!1,t.finish(16);case 20:case"end":return t.stop()}}),t,null,[[3,13,16,20]])})))()},onDeleteCancel:function(){this.theDeleteTaskId=void 0,this.theDeleteTaskName="",this.isDeleteDialogShow=!1},onCloneTaskClick:function(e){this.hasPermission(["task_clone"],e.auth_actions)?(this.isTaskCloneDialogShow=!0,this.theCloneTaskId=e.id,this.theCloneTaskName=e.name):this.onTaskPermissonCheck(["task_clone"],e)},onCloneConfirm:function(e){var t=this;return r()(p.a.mark((function a(){var s,i;return p.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(!t.pending.clone){a.next=2;break}return a.abrupt("return");case 2:return t.pending.clone=!0,s={name:e,task_id:t.theCloneTaskId},a.prev=4,a.next=7,t.cloneTask(s);case 7:i=a.sent,t.$router.push({name:"taskExecute",params:{project_id:t.project_id},query:{instance_id:i.data.new_instance_id}}),a.next=14;break;case 11:a.prev=11,a.t0=a.catch(4),console.log(a.t0);case 14:case"end":return a.stop()}}),a,null,[[4,11]])})))()},onCloneCancel:function(){this.isTaskCloneDialogShow=!1,this.theCloneTaskName=""},onSelectedStatus:function(e){this.isStarted="nonExecution"!==e,this.isFinished="finished"===e},onClearStatus:function(){this.isStarted=void 0,this.isFinished=void 0},handleSettingChange:function(e){var t=this,a=e.fields,s=e.size;this.setting.size=s,this.setting.selectedFields=a;var i=a.map(function(e){return u()(this,t),e.id}.bind(this));localStorage.setItem("TaskList",JSON.stringify({fieldList:i,size:s}))},onPageChange:function(e){this.pagination.current=e,this.updateUrl(),this.getTaskList()},onPageLimitChange:function(e){this.pagination.limit=e,this.pagination.current=1,this.updateUrl(),this.getTaskList()},updateUrl:function(){var e=this,t=this.pagination,a=t.current,s=t.limit,i=this.requestData,n=i.category,r=i.executeTime,o=i.createMethod,c=i.creator,l=i.executor,d=i.statusSync,p=i.taskName,h={limit:s,category:n,creator:c,executor:l,statusSync:d,createMethod:o,page:a,executeTime:r.every(function(t){return u()(this,e),t}.bind(this))?r.join(","):"",keyword:p},m={};Object.keys(h).forEach(function(t){u()(this,e);var a=h[t];(a||0===a||!1===a)&&(m[t]=a)}.bind(this)),this.$router.push({name:"taskList",params:{project_id:this.project_id},query:m})},getCreateMethod:function(){var e=this;return r()(p.a.mark((function t(){var a,s,i=this;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.loadCreateMethod();case 3:a=t.sent,e.taskCreateMethodList=a.data.map(function(e){return u()(this,i),{value:e.value,name:e.name}}.bind(this)),(s=e.searchForm.find(function(e){return u()(this,i),"createMethod"===e.key}.bind(this))).list=e.taskCreateMethodList,s.loading=!1,t.next=13;break;case 10:t.prev=10,t.t0=t.catch(0),console.log(t.t0);case 13:case"end":return t.stop()}}),t,this,[[0,10]])})))()},getData:function(){var e=this;return r()(p.a.mark((function t(){var a=this;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:Promise.all([e.getTaskList(),e.getCreateMethod(),e.getBizBaseInfo()]).catch(function(e){u()(this,a),console.log(e)}.bind(this));case 1:case"end":return t.stop()}}),t,this)})))()},transformCreateMethod:function(e){var t=this;return 0===this.taskCreateMethodList.length?"":this.taskCreateMethodList.find(function(a){return u()(this,t),a.value===e}.bind(this)).name},onCreateTask:function(){this.isNewTaskDialogShow=!0},onCreateTaskCancel:function(){this.isNewTaskDialogShow=!1},onSearchFormSubmit:function(e){this.requestData=Object.assign({},this.requestData,e),this.pagination.current=1,this.createInfo="",this.templateId="",this.templateSource="",this.updateUrl(),this.getTaskList()}})},I=(a(1401),Object(C.a)(N,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"task-container"},[a("skeleton",{attrs:{loading:e.firstLoading,loader:"taskList"}},[a("div",{staticClass:"list-wrapper"},[a("advance-search-form",{attrs:{id:"taskList",open:e.isSearchFormOpen,"search-config":{placeholder:e.$t("请输入任务名称")},"search-form":e.searchForm},on:{onSearchInput:e.onSearchInput,submit:e.onSearchFormSubmit},scopedSlots:e._u([{key:"operation",fn:function(){return[a("bk-button",{staticStyle:{"min-width":"120px"},attrs:{theme:"primary"},on:{click:e.onCreateTask}},[e._v("\n                        "+e._s(e.$t("新建"))+"\n                    ")])]},proxy:!0}])}),e._v(" "),a("div",{staticClass:"task-table-content"},[a("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:!e.firstLoading&&e.listLoading,opacity:1,zIndex:100},expression:"{ isLoading: !firstLoading && listLoading, opacity: 1, zIndex: 100 }"}],attrs:{data:e.taskList,pagination:e.pagination,size:e.setting.size},on:{"page-change":e.onPageChange,"page-limit-change":e.onPageLimitChange}},[e._l(e.setting.selectedFields,(function(t){return a("bk-table-column",{key:t.id,attrs:{label:t.label,prop:t.id,width:t.width,"min-width":t.min_width},scopedSlots:e._u([{key:"default",fn:function(s){return["name"===t.id?a("div",[e.hasPermission(["task_view"],s.row.auth_actions)?a("router-link",{staticClass:"template-operate-btn",attrs:{title:s.row.name,to:{name:"taskExecute",params:{project_id:e.project_id},query:{instance_id:s.row.id}}}},[e._v("\n                                    "+e._s(s.row.name)+"\n                                ")]):a("a",{directives:[{name:"cursor",rawName:"v-cursor"}],staticClass:"text-permission-disable",attrs:{title:s.row.name},on:{click:function(t){return e.onTaskPermissonCheck(["task_view"],s.row)}}},[e._v("\n                                    "+e._s(s.row.name)+"\n                                ")])],1):"create_method"===t.id?a("div",[e._v("\n                                "+e._s(e.transformCreateMethod(s.row.create_method))+"\n                            ")]):"task_status"===t.id?a("div",{staticClass:"task-status"},[a("span",{class:e.executeStatus[s.$index]&&e.executeStatus[s.$index].cls}),e._v(" "),e.executeStatus[s.$index]?a("span",{staticClass:"task-status-text"},[e._v(e._s(e.executeStatus[s.$index].text))]):e._e()]):[a("span",{attrs:{title:s.row[t.id]||"--"}},[e._v(e._s(s.row[t.id]||"--"))])]]}}],null,!0)})})),e._v(" "),a("bk-table-column",{attrs:{label:e.$t("操作"),width:"190"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("div",{staticClass:"task-operation"},[t.row.template_deleted?a("a",{staticClass:"task-operation-btn disabled"},[e._v(e._s(e.$t("再创建")))]):e.hasCreateTaskPerm(t.row)?a("router-link",{staticClass:"task-operation-btn",attrs:{to:e.getCreateTaskUrl(t.row)}},[e._v("\n                                    "+e._s(e.$t("再创建"))+"\n                                ")]):a("a",{directives:[{name:"cursor",rawName:"v-cursor"}],staticClass:"text-permission-disable task-operation-btn",on:{click:function(a){return e.onTaskPermissonCheck(["project"===t.row.template_source?"flow_create_task":"common_flow_create_task"],t.row)}}},[e._v("\n                                    "+e._s(e.$t("再创建"))+"\n                                ")]),e._v(" "),a("a",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["task_clone"],t.row.auth_actions)},expression:"{ active: !hasPermission(['task_clone'], props.row.auth_actions) }"}],class:["task-operation-btn",{"text-permission-disable":!e.hasPermission(["task_clone"],t.row.auth_actions)}],attrs:{href:"javascript:void(0);"},on:{click:function(a){return e.onCloneTaskClick(t.row,a)}}},[e._v("\n                                    "+e._s(e.$t("克隆"))+"\n                                ")]),e._v(" "),a("a",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["task_delete"],t.row.auth_actions)},expression:"{ active: !hasPermission(['task_delete'], props.row.auth_actions) }"}],class:["task-operation-btn",{"text-permission-disable":!e.hasPermission(["task_delete"],t.row.auth_actions)}],attrs:{href:"javascript:void(0);"},on:{click:function(a){return e.onDeleteTask(t.row,a)}}},[e._v("\n                                    "+e._s(e.$t("删除"))+"\n                                ")])],1)]}}])}),e._v(" "),a("bk-table-column",{attrs:{type:"setting"}},[a("bk-table-setting-content",{attrs:{fields:e.setting.fieldList,selected:e.setting.selectedFields,size:e.setting.size},on:{"setting-change":e.handleSettingChange}})],1),e._v(" "),a("div",{staticClass:"empty-data",attrs:{slot:"empty"},slot:"empty"},[a("NoData",{attrs:{message:e.$t("无数据")}})],1)],2)],1)],1)]),e._v(" "),a("TaskCreateDialog",{attrs:{entrance:"taskflow",project_id:e.project_id,"is-new-task-dialog-show":e.isNewTaskDialogShow,"business-info-loading":e.businessInfoLoading,"task-category":e.taskCategory},on:{onCreateTaskCancel:e.onCreateTaskCancel}}),e._v(" "),a("TaskCloneDialog",{attrs:{"is-task-clone-dialog-show":e.isTaskCloneDialogShow,"task-name":e.theCloneTaskName,pending:e.pending.clone},on:{confirm:e.onCloneConfirm,cancel:e.onCloneCancel}}),e._v(" "),a("bk-dialog",{attrs:{width:"400","ext-cls":"common-dialog",theme:"primary","mask-close":!1,"header-position":"left",title:e.$t("删除"),value:e.isDeleteDialogShow},on:{confirm:e.onDeleteConfirm,cancel:e.onDeleteCancel}},[a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.pending.delete,opacity:1,zIndex:100},expression:"{ isLoading: pending.delete, opacity: 1, zIndex: 100 }"}],staticClass:"dialog-content"},[e._v("\n            "+e._s(e.$t("确认删除")+'"'+e.theDeleteTaskName+'"?')+"\n        ")])])],1)}),[],!1,null,"0e5634dd",null));t.default=I.exports},685:function(e,t,a){"use strict";a(26),a(38),a(37),a(49),a(22),a(50);var s=a(16),i=a.n(s),n=a(0),r=a.n(n),o=a(5),c=a.n(o),l=a(4),u=a.n(l),d=(a(127),a(184),a(7)),p=a(1);function h(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function m(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?h(Object(a),!0).forEach((function(t){c()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):h(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var k={methods:m(m({},Object(d.b)("task/",["getInstanceStatus"])),{},{getExecuteStatus:function(e,t){var a=this;this[e]=t.map(function(t,s){r()(this,a);var i={};return t.is_expired?(i.cls="expired bk-icon icon-clock-shape",i.text=p.a.t("已过期")):t.is_finished?(i.cls="finished bk-icon icon-check-circle-shape",i.text=p.a.t("完成")):t.is_revoked?(i.cls="revoke common-icon-dark-circle-shape",i.text=p.a.t("撤销")):t.is_started?(i.cls="loading common-icon-loading",this.getExecuteDetail(e,t,s)):(i.cls="created common-icon-dark-circle-shape",i.text=p.a.t("未执行")),i}.bind(this))},getExecuteDetail:function(e,t,a){var s=this;return i()(u.a.mark((function i(){var n,r,o,c;return u.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return n={instance_id:t.id,project_id:t.project.id},i.prev=1,i.next=4,s.getInstanceStatus(n);case 4:if(!(r=i.sent).result){i.next=28;break}o=r.data.state,c={},i.t0=o,i.next="RUNNING"===i.t0||"BLOCKED"===i.t0?11:"READY"===i.t0?14:"SUSPENDED"===i.t0?17:"NODE_SUSPENDED"===i.t0?20:"FAILED"===i.t0?23:26;break;case 11:return c.cls="running common-icon-dark-circle-ellipsis",c.text=p.a.t("执行中"),i.abrupt("break",27);case 14:return c.cls="running common-icon-dark-circle-ellipsis",c.text=p.a.t("排队中"),i.abrupt("break",27);case 17:return c.cls="execute common-icon-dark-circle-pause",c.text=p.a.t("暂停"),i.abrupt("break",27);case 20:return c.cls="execute",c.text=p.a.t("节点暂停"),i.abrupt("break",27);case 23:return c.cls="failed common-icon-dark-circle-close",c.text=p.a.t("失败"),i.abrupt("break",27);case 26:c.text=p.a.t("未知");case 27:s[e].splice(a,1,c);case 28:i.next=33;break;case 30:i.prev=30,i.t1=i.catch(1),console.log(i.t1);case 33:case"end":return i.stop()}}),i,null,[[1,30]])})))()}})};t.a=k},727:function(e,t,a){},848:function(e,t,a){"use strict";a(727)},858:function(e,t,a){"use strict";a(26),a(38),a(49),a(50);var s=a(51),i=a.n(s),n=a(16),r=a.n(n),o=a(0),c=a.n(o),l=a(5),u=a.n(l),d=a(4),p=a.n(d),h=(a(67),a(127),a(23),a(22),a(37),a(80),a(24),a(83),a(27),a(52),a(1)),m=a(28),k=a(7),f=a(102),v=a(611);function _(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function b(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?_(Object(a),!0).forEach((function(t){u()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):_(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var g={name:"TaskCreateDialog",components:{NoData:v.a},mixins:[f.a],props:{isNewTaskDialogShow:Boolean,businessInfoLoading:Boolean,project_id:[Number,String],taskCategory:Array,entrance:String},data:function(){return{selectedTpl:{},taskListPending:!0,searchMode:!1,selectError:!1,commonTplList:[],businessTplList:[],templateList:[],templateType:[{id:"businessProcess",name:h.a.t("项目流程")},{id:"publicProcess",name:h.a.t("公共流程")}],selectedTplType:"businessProcess",selectedTplCategory:"all",selectedTplLabel:[],searchWord:"",nowTypeList:[],templateLabels:[],templateLabelLoading:!1,permissionLoading:!1,hasCommonTplCreateTaskPerm:!0,tplOperations:[],tplResource:{},commonTplOperations:[],commonTplResource:{}}},computed:b(b(b({},Object(k.e)({permissionMeta:function(e){return c()(this,void 0),e.permissionMeta}.bind(void 0)})),Object(k.e)("project/",{projectName:function(e){return c()(this,void 0),e.projectName}.bind(void 0),projectAuthActions:function(e){return c()(this,void 0),e.authActions}.bind(void 0)})),{},{templateCategories:function(){var e=this,t=m.a.deepClone(this.taskCategory);return t.unshift({value:"all",name:h.a.t("全部分类")}),t.map(function(t){return c()(this,e),{value:t.value,name:t.name}}.bind(this))},categoryListPending:function(){return 0!==this.taskCategory.length&&!1===this.taskListPending},isNoData:function(){return 0===this.templateList.length},resource:function(){return"businessProcess"===this.selectedTplType?this.tplResource:this.commonTplResource},action:function(){return"taskflow"===this.entrance?"businessProcess"===this.selectedTplType?["flow_create_task"]:["common_flow_create_task"]:"businessProcess"===this.selectedTplType?["flow_create_periodic_task"]:["common_flow_create_periodic_task"]}}),created:function(){this.onSearchInput=m.a.debounce(this.searchInputhandler,500)},methods:b(b(b(b({},Object(k.b)(["queryUserPermission"])),Object(k.b)("templateList/",["loadTemplateList"])),Object(k.b)("project/",["getProjectLabelsWithDefault"])),{},{getBusinessData:function(){var e=this;return r()(p.a.mark((function t(){var a,s;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.taskListPending=!0,t.prev=1,t.next=4,e.loadTemplateList({project__id:e.project_id});case 4:a=t.sent,s=a.objects,e.tplOperations=a.meta.auth_operations,e.tplResource=a.meta.auth_resource,e.businessTplList=s,e.templateList=s,t.next=15;break;case 12:t.prev=12,t.t0=t.catch(1),console.log(t.t0);case 15:return t.prev=15,e.taskListPending=!1,t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[1,12,15,18]])})))()},getcommonData:function(){var e=this;return r()(p.a.mark((function t(){var a,s,i;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.taskListPending=!0,a={common:1},t.prev=2,t.next=5,e.loadTemplateList(a);case 5:s=t.sent,i=s.objects,e.commonTplOperations=s.meta.auth_operations,e.commonTplResource=s.meta.auth_resource,e.commonTplList=e.getGroupedList(i),t.next=15;break;case 12:t.prev=12,t.t0=t.catch(2),console.log(t.t0);case 15:return t.prev=15,e.taskListPending=!1,t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[2,12,15,18]])})))()},getTemplateLabelList:function(){var e=this;return r()(p.a.mark((function t(){var a;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.templateLabelLoading=!0,t.next=4,e.getProjectLabelsWithDefault(e.project_id);case 4:a=t.sent,e.templateLabels=a.data,t.next=11;break;case 8:t.prev=8,t.t0=t.catch(0),console.log(t.t0);case 11:return t.prev=11,e.templateLabelLoading=!1,t.finish(11);case 14:case"end":return t.stop()}}),t,null,[[0,8,11,14]])})))()},getGroupedList:function(e){var t=this,a=[],s=[];return this.taskCategory.forEach(function(e){c()(this,t),a.push(e.name),s.push({id:e.value,name:e.name,children:[]})}.bind(this)),e.forEach(function(e){c()(this,t);var i=e.category_name,n=a.indexOf(i);n>-1&&s[n].children.push({id:e.id,name:e.name,project:e.project,auth_actions:e.auth_actions})}.bind(this)),s.filter(function(e){return c()(this,t),e.children.length}.bind(this))},toggleShow:function(e){var t=this;return r()(p.a.mark((function a(){return p.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(!e){a.next=5;break}return t.getTemplateLabelList(),a.next=4,t.getBusinessData();case 4:t.onFiltrationTemplate();case 5:case"end":return a.stop()}}),a)})))()},onCreateTask:function(){if("number"==typeof this.selectedTpl.id){if(!this.permissionLoading)if(this.hasCommonTplCreateTaskPerm){var e={name:"taskCreate",params:{project_id:this.project_id,step:"selectnode"},query:{template_id:this.selectedTpl.id,common:"publicProcess"===this.selectedTplType?"1":void 0,entrance:this.entrance||void 0}};this.$router.push(e)}else this.applyCommonTplCreateTaskPerm()}else this.selectError=!0},onCancel:function(){this.selectedTplType="businessProcess",this.selectedTplCategory="all",this.selectedTpl={},this.selectError=!1,this.selectedTplLabel=[],this.$emit("onCreateTaskCancel")},onSelectTpl:function(e){if("businessProcess"===this.selectedTplType)if(this.hasPermission(this.action,e.auth_actions))this.selectError=!1,this.selectedTpl=e;else{var t={flow:[{id:e.id,name:e.name}],project:[{id:e.project.id,name:e.project.name}]};this.applyForPermission(this.action,e.auth_actions,t)}else this.selectError=!1,this.selectedTpl=e,this.checkCommonTplPermission(e)},checkCommonTplPermission:function(e){var t=this;return r()(p.a.mark((function a(){var s,i,n,r=this;return p.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,t.permissionLoading=!0,s=t.permissionMeta.system.find(function(e){return c()(this,r),"bk_sops"===e.id}.bind(this)),i={action:"taskflow"===t.entrance?"common_flow_create_task":"common_flow_create_periodic_task",resources:[{system:s.id,type:"project",id:t.project_id,attributes:{}},{system:s.id,type:"common_flow",id:e.id,attributes:{}}]},a.next=6,t.queryUserPermission(i);case 6:n=a.sent,t.hasCommonTplCreateTaskPerm=n.data.is_allow,a.next=13;break;case 10:a.prev=10,a.t0=a.catch(0),console.log(a.t0);case 13:return a.prev=13,t.permissionLoading=!1,a.finish(13);case 16:case"end":return a.stop()}}),a,this,[[0,10,13,16]])})))()},applyCommonTplCreateTaskPerm:function(){var e="taskflow"===this.entrance?["common_flow_create_task"]:["common_flow_create_periodic_task"],t=[].concat(i()(this.selectedTpl.auth_actions),i()(this.projectAuthActions)),a={common_flow:[{id:this.selectedTpl.id,name:this.selectedTpl.name}],project:[{id:this.project_id,name:this.projectName}]};this.applyForPermission(e,t,a)},searchInputhandler:function(){var e=this,t=[],a=new RegExp(this.searchWord,"i"),s=m.a.deepClone(this.nowTypeList);t="publicProcess"===this.selectedTplType?s.filter(function(t){var s=this;return c()(this,e),t.children=t.children.filter(function(e){return c()(this,s),a.test(e.name)}.bind(this)),t.children.length}.bind(this)):s.filter(function(t){return c()(this,e),a.test(t.name)}.bind(this)),this.templateList=t},onChooseTplType:function(e){var t=this;return r()(p.a.mark((function a(){return p.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(t.selectedTplType=e,t.selectedTpl={},t.templateList=[],t.searchWord="","businessProcess"!==e){a.next=10;break}return t.selectedTplLabel=[],a.next=8,t.getBusinessData();case 8:a.next=13;break;case 10:return t.selectedTplCategory="all",a.next=13,t.getcommonData();case 13:t.onFiltrationTemplate();case 14:case"end":return a.stop()}}),a)})))()},onLabelChange:function(){this.onFiltrationTemplate()},onChooseTplCategory:function(e){this.selectedTplCategory=e,this.selectedTpl={},this.onFiltrationTemplate()},onFiltrationTemplate:function(){var e=this,t="businessProcess"===this.selectedTplType?this.businessTplList:this.commonTplList,a=m.a.deepClone(t);"businessProcess"===this.selectedTplType?a=a.filter(function(t){var a=this;return c()(this,e),this.selectedTplLabel.every(function(e){var s=this;return c()(this,a),t.template_labels.find(function(t){return c()(this,s),t.label_id===Number(e)}.bind(this))}.bind(this))}.bind(this)):"all"!==this.selectedTplCategory&&(a=a.filter(function(t){return c()(this,e),t.id===this.selectedTplCategory}.bind(this))),this.templateList=a,this.nowTypeList=a,""!==this.searchWord&&this.searchInputhandler()}})},T=(a(848),a(9)),y=Object(T.a)(g,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("bk-dialog",{staticClass:"new-task-dialog",attrs:{width:"850","ext-cls":"common-dialog",theme:"primary","mask-close":!1,"header-position":"left",title:e.$t("新建任务"),value:e.isNewTaskDialogShow,"auto-close":!1},on:{"value-change":e.toggleShow}},[a("div",{staticClass:"task-container"},[a("div",{staticClass:"task-wrapper"},[a("div",{staticClass:"filtrate-wrapper"},[a("div",{staticClass:"task-search"},[a("bk-select",{staticClass:"bk-select-inline",attrs:{value:e.selectedTplType,"popover-width":260,disabled:!e.categoryListPending,clearable:!1},on:{selected:e.onChooseTplType}},e._l(e.templateType,(function(e,t){return a("bk-option",{key:t,attrs:{id:e.id,name:e.name}})})),1)],1),e._v(" "),a("div",{staticClass:"task-search"},["publicProcess"===e.selectedTplType?a("bk-select",{staticClass:"bk-select-inline",attrs:{value:e.selectedTplCategory,"popover-width":260,disabled:!e.categoryListPending,clearable:!1},on:{selected:e.onChooseTplCategory}},e._l(e.templateCategories,(function(e,t){return a("bk-option",{key:t,attrs:{id:e.value,name:e.name}})})),1):a("bk-select",{key:"label-select",staticClass:"bk-select-inline",attrs:{"ext-popover-cls":"label-select",placeholder:e.$t("请选择标签"),"popover-width":260,"display-tag":!0,multiple:!0},on:{change:e.onLabelChange},model:{value:e.selectedTplLabel,callback:function(t){e.selectedTplLabel=t},expression:"selectedTplLabel"}},e._l(e.templateLabels,(function(t,s){return a("bk-option",{key:s,attrs:{id:t.id,name:t.name}},[a("div",{staticClass:"label-select-option"},[a("span",{staticClass:"label-select-color",style:{background:t.color}}),e._v(" "),a("span",[e._v(e._s(t.name))]),e._v(" "),a("i",{staticClass:"bk-option-icon bk-icon icon-check-1"})])])})),1)],1),e._v(" "),a("div",{staticClass:"task-search"},[a("bk-input",{staticClass:"search-input",attrs:{placeholder:e.$t("请输入关键字"),"right-icon":"bk-icon icon-search",clearable:!0},on:{input:e.onSearchInput},model:{value:e.searchWord,callback:function(t){e.searchWord="string"==typeof t?t.trim():t},expression:"searchWord"}})],1)]),e._v(" "),a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.taskListPending,opacity:1,zIndex:100},expression:"{ isLoading: taskListPending, opacity: 1, zIndex: 100 }"}],staticClass:"task-list"},[e.isNoData?a("NoData",{staticClass:"empty-task"},[e._v(e._s(e.$t("搜索结果为空")))]):a("ul",{staticClass:"grouped-list"},["publicProcess"===e.selectedTplType?[e._l(e.templateList,(function(t){return[t.children.length?a("li",{key:t.id,staticClass:"task-group"},[a("h5",{staticClass:"task-name"},[e._v("\n                                    "+e._s(t.name)+"\n                                    ("),a("span",{staticClass:"list-count"},[e._v(e._s(t.children.length))]),e._v(")\n                                ")]),e._v(" "),a("ul",e._l(t.children,(function(t){return a("li",{key:t.id,class:["task-item",{"task-item-selected":e.selectedTpl.id===t.id,"permission-disable":"businessProcess"===e.selectedTplType&&!e.hasPermission(e.action,t.auth_actions)}],attrs:{title:t.name},on:{click:function(a){return e.onSelectTpl(t)}}},[a("div",{staticClass:"task-item-icon"},[e._v(e._s(t.name.substr(0,1).toUpperCase()))]),e._v(" "),a("div",{staticClass:"task-item-name-box"},[a("div",{staticClass:"task-item-name"},[e._v(e._s(t.name))])]),e._v(" "),a("div",{staticClass:"apply-permission-mask"},[a("bk-button",{attrs:{theme:"primary",size:"small"}},[e._v(e._s(e.$t("申请权限")))])],1)])})),0)]):e._e()]}))]:e._l(e.templateList,(function(t){return a("li",{key:t.id,class:["task-item",{"task-item-selected":e.selectedTpl.id===t.id,"permission-disable":"businessProcess"===e.selectedTplType&&!e.hasPermission(e.action,t.auth_actions)}],attrs:{title:t.name},on:{click:function(a){return e.onSelectTpl(t)}}},[a("div",{staticClass:"task-item-icon"},[e._v(e._s(t.name.substr(0,1).toUpperCase()))]),e._v(" "),a("div",{staticClass:"task-item-name-box"},[a("div",{staticClass:"task-item-name"},[e._v(e._s(t.name))])]),e._v(" "),a("div",{staticClass:"apply-permission-mask"},[a("bk-button",{attrs:{theme:"primary",size:"small"}},[e._v(e._s(e.$t("申请权限")))])],1)])}))],2)],1)]),e._v(" "),e.selectError?a("div",{staticClass:"task-footer"},[a("span",{staticClass:"error-info"},[e._v(e._s(e.$t("请选择流程模版")))])]):e._e()]),e._v(" "),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:"publicProcess"===e.selectedTplType&&!e.hasCommonTplCreateTaskPerm},expression:"{\n                active: selectedTplType === 'publicProcess' && !hasCommonTplCreateTaskPerm\n            }"}],class:{"btn-permission-disable":"publicProcess"===e.selectedTplType&&!e.hasCommonTplCreateTaskPerm},attrs:{theme:"primary",loading:e.permissionLoading},on:{click:e.onCreateTask}},[e._v("\n            "+e._s(e.$t("确定"))+"\n        ")]),e._v(" "),a("bk-button",{on:{click:e.onCancel}},[e._v(e._s(e.$t("取消")))])],1)])}),[],!1,null,"08a82b04",null);t.a=y.exports}}]);